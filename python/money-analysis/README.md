# 予算予測モデル

このプロジェクトは、予算の計画値と実績データから予測モデルを作成し、新しいデータに対して「着地見込み額合計」を予測するためのツールです。

## ファイル構成

- `data-sample.xlsx`: 元データ（特徴量と実績値を含むExcelファイル）
- `analyze_excel.py`: Excelデータの基本情報を確認するスクリプト
- `prediction_model.py`: ランダムフォレスト予測モデルを作成するスクリプト
- `predict.py`: ランダムフォレストモデルを使用して予測を行うスクリプト
- `prediction_model.pkl`: 保存されたランダムフォレストモデル
- `prediction_vs_actual.png`: ランダムフォレストモデルの予測値と実際の値の比較グラフ
- `feature_importance.png`: 特徴量の重要度グラフ
- `improved_model.py`: 複数のモデルを評価して最適なモデルを選択するスクリプト
- `improved_predict.py`: 最適なモデルを使用して予測を行うスクリプト
- `best_prediction_model.pkl`: 保存された最適なモデル
- `model_comparison.png`: 各モデルの性能比較グラフ
- `best_model_prediction.png`: 最適なモデルの予測値と実際の値の比較グラフ

## 使用方法

### 1. データの確認

以下のコマンドを実行して、Excelデータの基本情報を確認できます：

```bash
python analyze_excel.py
```

### 2. モデルの作成

#### 2.1 ランダムフォレストモデル

以下のコマンドを実行してランダムフォレスト予測モデルを作成します：

```bash
python prediction_model.py
```

このスクリプトは以下の処理を行います：
- `data-sample.xlsx` からデータを読み込む
- データの前処理（欠損値の処理など）
- ランダムフォレスト回帰モデルの作成とハイパーパラメータのチューニング
- モデルの評価（MSE、RMSE、R²）
- 予測値と実際の値の比較グラフの作成
- 特徴量の重要度の計算と可視化
- モデルの保存（`prediction_model.pkl`）
- 予測用スクリプト（`predict.py`）の作成

#### 2.2 改良されたモデル

以下のコマンドを実行して複数のモデルを評価し、最適なモデルを選択します：

```bash
python improved_model.py
```

このスクリプトは以下の処理を行います：
- `data-sample.xlsx` からデータを読み込む
- データの前処理（欠損値の処理など）
- 複数のモデル（RandomForest、GradientBoosting、AdaBoost、ElasticNet、Lasso、Ridge、SVR、MLP）の評価
- 各モデルのハイパーパラメータのチューニング
- 最適なモデルの選択
- モデル比較グラフの作成
- 最適なモデルの予測値と実際の値の比較グラフの作成
- 最適なモデルの保存（`best_prediction_model.pkl`）
- 予測用スクリプト（`improved_predict.py`）の作成

### 3. 新しいデータに対する予測

#### 3.1 ランダムフォレストモデルを使用した予測

```bash
python predict.py <予測したいExcelファイルのパス>
```

予測結果は `prediction_results.xlsx` として保存されます。

#### 3.2 最適なモデルを使用した予測

```bash
python improved_predict.py <予測したいExcelファイルのパス>
```

予測結果は `improved_prediction_results.xlsx` として保存されます。

## モデルの性能

### ランダムフォレストモデル
- 平均二乗誤差 (MSE): 156001.51
- 平方根平均二乗誤差 (RMSE): 394.97
- 決定係数 (R²): 0.21

### 改良されたモデル（MLP - ニューラルネットワーク）
- 平均二乗誤差 (MSE): 136549.21
- 平方根平均二乗誤差 (RMSE): 369.53
- 決定係数 (R²): 0.31
- 最適なパラメータ: {'regressor__alpha': 0.0001, 'regressor__hidden_layer_sizes': (50, 50), 'regressor__learning_rate': 'constant'}

改良されたモデル（MLP）は、ランダムフォレストモデルと比較して精度が向上しています。決定係数（R²）が0.21から0.31に向上し、RMSEも394.97から369.53に減少しています。ただし、依然として決定係数が0.31と低めなので、さらなる改善の余地があります。

## 特徴量

モデルは以下の特徴量を使用します：
- ISS区分
- 部
- 部門
- 担当
- 投資_リース

### ランダムフォレストモデルの特徴量の重要度（上位5）：
1. 担当: 0.3630
2. 部門_a: 0.1339
3. 部門_d: 0.0919
4. 部門_b: 0.0637
5. ISS区分_システム: 0.0633

## 目的変数

予測対象は以下の変数です：
- 着地見込み額合計

## 各モデルの比較

以下のモデルを評価しました：

| モデル | 決定係数 (R²) | RMSE |
|-------|-------------|------|
| MLP (ニューラルネットワーク) | 0.31 | 369.53 |
| Ridge | 0.25 | 384.43 |
| Lasso | 0.22 | 392.64 |
| RandomForest | 0.21 | 395.54 |
| AdaBoost | 0.20 | 397.18 |
| GradientBoosting | 0.19 | 400.10 |
| ElasticNet | 0.12 | 415.46 |
| SVR | 0.02 | 440.31 |

MLPモデル（ニューラルネットワーク）が最も高い精度を示しました。

## さらなる改善の余地

モデルの精度をさらに向上させるためには、以下の方法が考えられます：

1. より多くの特徴量を追加する
   - 現在の特徴量だけでは目的変数の変動を十分に説明できていない可能性があります
   - 例えば、過去の実績データや、他の関連する財務指標などを追加することで精度が向上する可能性があります
   - 特徴量の重要度分析から、「担当」が最も重要な特徴量であることがわかりました。この特徴量に関連する追加情報を収集することが有効かもしれません

2. より高度なモデルを試す
   - XGBoostやLightGBMなどの高度なアンサンブルモデルを試すことで、精度が向上する可能性があります
   - ディープラーニングモデルを試すことも考えられます
   - 複数のモデルを組み合わせたアンサンブル手法も効果的かもしれません

3. ハイパーパラメータのチューニングをさらに詳細に行う
   - より広範囲のパラメータを試すことで、モデルの性能が向上する可能性があります
   - ベイズ最適化などの高度なチューニング手法を使用することも考えられます
   - MLPモデルの場合、イテレーション数を増やすことで収束する可能性があります

4. データの前処理を改善する
   - 外れ値の処理や特徴量のスケーリングなどを行うことで、モデルの性能が向上する可能性があります
   - 特徴量エンジニアリングを行い、既存の特徴量から新しい特徴量を作成することも考えられます
   - カテゴリカル変数のエンコーディング方法を改善することも効果的かもしれません

5. データ量の増加
   - 現在のデータセットは100サンプルのみであり、これは機械学習モデルにとっては非常に少ないです
   - より多くのデータを収集することで、モデルの精度が向上する可能性があります
   - データ拡張技術を使用して、既存のデータから新しいサンプルを生成することも考えられます

6. 特徴量選択の最適化
   - 不要な特徴量を削除することで、モデルの過学習を防ぎ、精度を向上させる可能性があります
   - 特徴量の重要度に基づいて、最も重要な特徴量のみを使用することも効果的かもしれません
   - 主成分分析（PCA）などの次元削減手法を使用することも考えられます

7. 交差検証の改善
   - より堅牢な評価を行うために、k分割交差検証を使用することが考えられます
   - データセットが小さいため、Leave-One-Out交差検証を使用することも効果的かもしれません

## 注意事項

- 予測に使用するExcelファイルには、上記の特徴量が含まれている必要があります。
- モデルの精度は元データの品質と量に依存します。
- 定期的にモデルを再トレーニングすることで、最新のデータに基づいた予測が可能になります。
- 改良されたモデル（MLP）は、ランダムフォレストモデルよりも精度が高いですが、計算コストも高くなる可能性があります。
